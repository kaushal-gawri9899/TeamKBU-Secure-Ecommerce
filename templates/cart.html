<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <!--  This file has been downloaded from bootdey.com @bootdey on twitter -->
    <!--  All snippets are MIT license http://bootdey.com/license -->
    <title>Product Listing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <link href="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
</head>

<body>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <div class="header">
        <a href="#default" class="logo">TEAM KBU</a>
        <div class="header-right">
            <a class="activeRight1" href="/seeAllProducts">Home</a>
            <a class="activeRight3" href="/cart">Cart</a>
            <a class="activeRight2" href="/">Logout</a>
        </div>
    </div>

    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1'>
        <title>Snippet - BBBootstrap</title>
        <link href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css' rel='stylesheet'>
        <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css' rel='stylesheet'>
        <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js'></script>
        <style>
            button:hover {
                bottom: 0.1em;
            }

            button:focus {
                outline: 0;
            }

            button:active {
                bottom: 0;
                background-color: #fdf;
            }

            .header {
                overflow: hidden;
                background-color: black;
                padding: 20px 10px;
            }

            /* Style the header links */
            .header a {
                float: left;
                color: black;
                text-align: center;
                padding: 12px;
                text-decoration: none;
                font-size: 18px;
                line-height: 25px;
                border-radius: 4px;
            }

            /* Style the logo link (notice that we set the same value of line-height and font-size to prevent the header to increase when the font gets bigger */
            .header a.logo {
                font-size: 25px;
                font-weight: bold;
                color: white;
            }

            /* Change the background color on mouse-over */
            .header a:hover {
                background-color: #ddd;
                color: black;
            }

            /* Style the active/current link*/
            .header a.active {
                background-color: dodgerblue;
                color: white;
                margin-right: 2rem;
            }

            /* Float the link section to the right */
            .header-right {
                float: right;
            }

            .header a.activeRight2:hover {
                background-color: #ddd;
                color: black;
            }

            .header a.activeRight1:hover {
                background-color: #ddd;
                color: black;
            }

            .header a.activeRight3:hover {
                background-color: #ddd;
                color: black;
            }


            .header a.activeRight2 {
                bottom: 0;
                background-color: dodgerblue;
                color: white;
            }

            .header a.activeRight1 {
                bottom: 0;
                background-color: dodgerblue;
                color: white;
                margin-right: 2rem;
            }

            .header a.activeRight3 {
                bottom: 0;
                background-color: dodgerblue;
                color: white;
                margin-right: 2rem;
            }

            body {
                color: #000;
                overflow-x: hidden;
                height: 100%;
                background-color: #fff;
                background-repeat: no-repeat
            }

            .plus-minus {
                position: relative
            }

            .plus {
                position: absolute;
                top: -4px;
                left: 2px;
                cursor: pointer
            }

            .minus {
                position: absolute;
                top: 8px;
                left: 5px;
                cursor: pointer
            }

            .vsm-text:hover {
                color: #FF5252
            }

            .book,
            .book-img {
                width: 120px;
                height: 180px;
                border-radius: 5px
            }

            .book {
                margin: 20px 15px 5px 15px
            }

            .border-top {
                border-top: 1px solid #EEEEEE !important;
                margin-top: 20px;
                padding-top: 15px
            }

            .card {
                margin: 40px 0px;
                padding: 40px 50px;
                border-radius: 20px;
                border: none;
                box-shadow: 1px 5px 10px 1px rgba(0, 0, 0, 0.2)
            }

            input,
            textarea {
                background-color: #F3E5F5;
                padding: 8px 15px 8px 15px;
                width: 100%;
                border-radius: 5px !important;
                box-sizing: border-box;
                border: 1px solid #F3E5F5;
                font-size: 15px !important;
                color: #000 !important;
                font-weight: 300
            }

            input:focus,
            textarea:focus {
                -moz-box-shadow: none !important;
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
                border: 1px solid #9FA8DA;
                outline-width: 0;
                font-weight: 400
            }

            button:focus {
                -moz-box-shadow: none !important;
                -webkit-box-shadow: none !important;
                box-shadow: none !important;
                outline-width: 0
            }

            .pay {
                width: 80px;
                height: 40px;
                border-radius: 5px;
                border: 1px solid #673AB7;
                margin: 10px 20px 10px 0px;
                cursor: pointer;
                box-shadow: 1px 5px 10px 1px rgba(0, 0, 0, 0.2)
            }

            .gray {
                -webkit-filter: grayscale(100%);
                -moz-filter: grayscale(100%);
                -o-filter: grayscale(100%);
                -ms-filter: grayscale(100%);
                filter: grayscale(100%);
                color: #E0E0E0
            }

            .gray .pay {
                box-shadow: none
            }

            #tax {
                border-top: 1px lightgray solid;
                margin-top: 10px;
                padding-top: 10px
            }

            .btn-blue {
                border: none;
                border-radius: 10px;
                background-color: #673AB7;
                color: #fff;
                padding: 8px 15px;
                margin: 20px 0px;
                cursor: pointer
            }

            .btn-blue:hover {
                background-color: #311B92;
                color: #fff
            }

            #checkout {
                float: left
            }

            #check-amt {
                float: right
            }

            @media screen and (max-width: 768px) {

                .book,
                .book-img {
                    width: 100px;
                    height: 150px
                }

                .card {
                    padding-left: 15px;
                    padding-right: 15px
                }

                .mob-text {
                    font-size: 13px
                }

                .pad-left {
                    padding-left: 20px
                }
            }
        </style>
        <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="http://passport.cnblogs.com/scripts/jsencrypt.min.js"></script>
        <script src="../static/js/rsa.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"> </script>


    <body oncontextmenu='return false' class='snippet-body'>
        <div class="container px-4 py-5 mx-auto">
            <div class="row d-flex justify-content-center">
                <div class="col-5" style="margin-left:0rem;">
                    <h4 class="heading">Image</h4>

                </div>
                <div class="col-7">
                    <div class="row text-right">
                        <div class="col-4" style="margin-left:-25rem;">
                            <h4 class="mt-2">Brand</h4>
                        </div>
                        <div class="col-4">
                            <h4 class="mt-2">Model</h4>
                        </div>
                        <div class="col-4">
                            <h4 class="mt-2">Quantity</h4>
                        </div>
                        <div class="col-4">
                            <h4 class="mt-2">Price</h4>
                        </div>
                    </div>
                </div>
            </div>
            <input id="hello" type="hidden" name="hello" value="{{ hello }}" />

            {% for i in range(numberOfelements) %}
            <div class="row d-flex justify-content-center border-top">
                <div class="col-5">
                    <div class="row d-flex">

                        <div class="book"><img src="{{url_for('static',filename='/img/'+items[i]['product_image'])}}"
                                class="book-img"></div>
                        <div class="my-auto flex-column d-flex pad-left">
                            <h6 class="mob-text" style="margin-left:25rem; margin-top: -6.6rem;">{{ items[i]['brand'] }}


                        </div>
                    </div>
                </div>
                <div class="my-auto col-7">
                    <div class="row text-right">
                        <div class="col-4">
                            <p class="mob-text" style="margin-top: 0rem;">{{ items[i]['model'] }}</p>

                        </div>

                        <div class="col-4">
                            <div class="row d-flex justify-content-end px-3">

                                <script>
                                    window.addEventListener('load', function () {
                                        var xhr = null;

                                        getXmlHttpRequestObject = function () {
                                            if (!xhr) {
                                                xhr = new XMLHttpRequest();
                                            }
                                            return xhr;
                                        };

                                        updateLiveData = function () {
                                            var url = 'http://secure-kpa.herokuapp.com/cart';
                                            xhr = getXmlHttpRequestObject();

                                            xhr.onreadystatechange = eventHandler;

                                            xhr.open("POST", url, true);

                                            xhr.send(null);
                                        };


                                        function eventHandler() {

                                            if ((xhr.readyState == 4 || xhr.readyState == 3 || xhr.readyState == 2 || xhr.readyState == 1) && xhr.status == 200) {

                                                data = document.getElementById('cnt2');
                                                data.value = "4";
                                                setTimeout(updateLiveData(), 1);
                                            }
                                        }

                                        //Uncomment
                                        // updateLiveData();
                                    });



                                </script>

                                <p class="mb-0" id="cnt2" name="cnt2">{{ items[i]['quantity'] }}</p>
                                <form id="{{ items[i]['_id']['$oid'] }}" method="post">
                                    <input id="token" type="hidden" name="token" value="{{ token }}" />
                                    <input id="oid_edit{{ items[i]['_id']['$oid'] }}" type="hidden" name="oid_edit"
                                        value="{{ items[i]['_id']['$oid'] }}"
                                        style="margin-left:25rem;  margin-top: 10px;" />
                                    <label for="quantity" style="margin-top: 5rem;">Quantity
                                        <select name="quantity" style="margin-left:25rem;"
                                            id="quantity{{ items[i]['_id']['$oid'] }}">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                        </select>
                                    </label>
                                    <script>
                                        function load(i) {

                                        }


                                    </script>
                                    <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
                                    <button id="updateButton{{ items[i]['_id']['$oid'] }}" onclick="update(this)"
                                        type="button" class="btn btn-primary btn-lg">Update Quantity</button>

                                    <form method="post">
                                        <input id="oiddelete{{ items[i]['_id']['$oid'] }}" type="hidden" name="oid"
                                            value="{{ items[i]['_id']['$oid'] }}" />
                                        <button id="delete{{ items[i]['_id']['$oid'] }}" onclick="deleteItem(this)"
                                            type="button" class="btn btn-danger btn-lg">Delete</button>
                                    </form>

                                    <script>

                                        function decryptData(requrl, data) {
                                            privatekey = "YOUR_RSA_PRIVATE_KEY";
                                            publickey = "YOUR_PUBLIC_KEY"

                                            var dept = new JSEncrypt();

                                            dept.setPrivateKey(privatekey);
                                            var senddata = new Object();

                                            var decrypted = dept.decrypt("WVEzKOT6DyTpxsU%2F113KgMVtdBM4nd%2Fwk6Po3JRzWgGF5VMbd9fiAbzl71Wt2wuGDXyfcSnEHv3a447SfesfPNWcy3vWsR2q7VuJmcKRNf7BEiu9EPOCx93860K%2B%2F2mHhMBIynp0%2BA%2BC93N7LdcKUtRyh1RP3zurIRKLNnYAtaxSRs9bNL%2BfP6rRYxZwUW%2BmXG%2B5vpjPxriVINrcuwGRwWJCAxjuG2SImrnWypf0sPZfcuhqmZb1iszX7n3vQ%2FxrzCocI0wr7UhN59okRENDY0QP5yY14Q31Alm%2BVJrJZ%2Bi6PfNldri3v1%2B89%2FQsr7PZoia1QOwzb5EiGq9n%2F23obg%3D%3D")


                                            $.ajax({
                                                url: requrl,
                                                type: "post",
                                                data: senddata,
                                                datatype: "json",
                                                success: function (response) {
                                                    window.location.href = "http://secure-kpa.herokuapp.com/cart";
                                                }
                                            }
                                            );
                                        }
                                        $(function () {
                                            $("#encryptNow").click(function () {

                                                var data = '{{data}}';

                                                decryptData("http://secure-kpa.herokuapp.com/cart", data);
                                            });
                                        });
                                    </script>
                                    </script>
                                </form>
                            </div>
                        </div>
                        <div class="col-4">
                            <h6 class="mob-text">${{ items[i]['price'] }}</h6>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
            <script src="http://passport.cnblogs.com/scripts/jsencrypt.min.js"></script>
            <script src="../static/js/rsa.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"> </script>
            <script type="text/javascript">

                function encryptPayDetails(requrl, data) {


                    var response = $.ajax({
                        url: requrl,
                        type: "post",
                        data: data,
                        datatype: "json",
                        success: function (response) {


                            if (response == "Failure Date") {
                                alert('Incorrect Card Date');
                                return;
                            }
                            if (response == "Failure cvv") {
                                alert('Incorrect length of cvv');
                                return;
                            }
                            if (response == "Failure number") {
                                alert('Incorrect card number');
                                return;
                            }

                            if (response == "Empty Request") {
                                alert('Empty Fields Provided');
                                return;
                            }
                            window.location.href = "http://secure-kpa.herokuapp.com/orders";

                        },
                        error: function (error) {
                            alert('Missing Card Details');
                        }
                    }
                    );

                }

                $(function () {
                    $("#testme").click(function () {

                        privatekey = "YOUR_RSA_PRIVATE_KEY";
                        publickey = "YOUR_PUBLIC_KEY";

                        var dataVal = [];



                        var data = {
                            "cnum": $('#cnum').val(),
                            "cname": $('#cname').val(),
                            "exp": $('#exp').val(),
                            "cvv": $('#cvv').val()
                        };

                        var encrypt = new JSEncrypt();
                        encrypt.setPublicKey(publickey);
                        var stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(data));
                        var encodedData = base64url(stringifiedData);
                        var getToken = document.getElementById('token').value;

                        var decrypt = new JSEncrypt();
                        decrypt.setPrivateKey(privatekey);
                        var tokenDecrypt = decrypt.decrypt(getToken);
                        if (tokenDecrypt == null) {
                            alert("Either Missing Payment Details or No Items In Cart!")
                            return;
                        }

                        var splitToken = tokenDecrypt.split('.')[0];

                        var senddata = new Object();
                        senddata['token'] = encrypt.encrypt(splitToken + '.' + encodedData);

                        var encryptToken = {
                            'token': senddata['token']
                        };

                        encryptPayDetails("/payment", encryptToken);
                    });
                });

            </script>
            <script>


                function base64url(source) {
                    // Encode in classical base64
                    encodedSource = CryptoJS.enc.Base64.stringify(source);

                    // Remove padding equal characters
                    encodedSource = encodedSource.replace(/=+$/, '');

                    // Replace characters according to base64url specifications
                    encodedSource = encodedSource.replace(/\+/g, '-');
                    encodedSource = encodedSource.replace(/\//g, '_');

                    return encodedSource;
                }

                function encryptrequest(formId) {


                    privatekey = "YOUR_RSA_PRIVATE_KEY";
                    var getToken = document.getElementById('token').value;

                    var decrypt = new JSEncrypt();
                    decrypt.setPrivateKey(privatekey);
                    var tokenDecrypt = decrypt.decrypt(getToken);
                    var splitToken = tokenDecrypt.split('.')[0];

                    var data = {
                        'oid': document.getElementById('oid' + formId).value
                    };

                    var stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(data));
                    var encodedData = base64url(stringifiedData);

                    publickey = "YOUR_PUBLIC_KEY";

                    var encrypt = new JSEncrypt();
                    encrypt.setPublicKey(publickey);
                    var senddata = new Object();
                    senddata['encrypted_token'] = encrypt.encrypt(splitToken + "." + encodedData);

                    var ourData = {

                        "token": senddata['encrypted_token']
                    }



                    $.ajax({
                        url: "http://secure-kpa.herokuapp.com/deleteCart",
                        cache: false,
                        type: "post",
                        data: ourData,
                        datatype: "json",
                        success: function (response) {
                            window.location.href = "http://secure-kpa.herokuapp.com/cart";
                        }
                    });


                }

                function encryptrequestForUpdate(data, formId) {


                    publickey = "YOUR_PUBLIC_KEY";

                    privatekey = "YOUR_RSA_PRIVATE_KEY";

                    var encrypt = new JSEncrypt();
                    encrypt.setPublicKey(publickey);


                    //The data object sent by the ajax request
                    var senddata = new Object();


                    //Assign the data array to the ajax object
                    senddata['OID'] = encrypt.encrypt(data);
                    var quantity = document.getElementById('quantity' + formId).value;

                    senddata['quantity'] = encrypt.encrypt(quantity);
                    var data = {
                        "quantity": document.getElementById('quantity' + formId).value,
                        "OID": document.getElementById('oid_edit' + formId).value
                    }

                    var stringifiedData = CryptoJS.enc.Utf8.parse(JSON.stringify(data));
                    var encodedData = base64url(stringifiedData);
                    var getToken = document.getElementById('token').value;
                    var decrypt = new JSEncrypt();
                    decrypt.setPrivateKey(privatekey);
                    var tokenDecrypt = decrypt.decrypt(getToken);
                    var splitToken = tokenDecrypt.split('.')[0];
                    senddata['token'] = encrypt.encrypt(splitToken + '.' + encodedData);

                    var encryptToken = {
                        'token': senddata['token']
                    };

                    $.ajax({
                        url: "http://secure-kpa.herokuapp.com/editCart",
                        cache: false,
                        type: "post",
                        data: encryptToken,
                        datatype: "json",
                        success: function (response) {
                            window.location.href = "http://secure-kpa.herokuapp.com/cart";
                        }
                    }
                    );
                }


                $('#submitButton').on('click', function () {


                    encryptrequest($('#oid').val());


                });

                function update(el) {


                    var formId = el.id;
                    let str = formId;
                    const myArr = str.split("updateButton");
                    var form = new FormData(document.getElementById(myArr[1]));
                    var inputValue = form.get("oid_edit");
                    encryptrequestForUpdate(inputValue, myArr[1]);

                };

                function deleteItem(el) {

                    var formId = el.id;


                    encryptrequest(formId);
                };

            </script>






            <form action="/payment" method="post">
                <div class="row justify-content-center">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="row">

                                <div class="col-lg-3 radio-group">
                                    <div class="row d-flex px-3 radio"> <img class="pay"
                                            src="https://i.imgur.com/WIAP9Ku.jpg">
                                        <p class="my-auto">Credit Card</p>
                                    </div>
                                    <div class="row d-flex px-3 radio gray"> <img class="pay"
                                            src="https://i.imgur.com/OdxcctP.jpg">
                                        <p class="my-auto">Debit Card</p>
                                    </div>
                                    <div class="row d-flex px-3 radio gray mb-3"> <img class="pay"
                                            src="https://i.imgur.com/cMk1MtK.jpg">
                                        <p class="my-auto">PayPal</p>
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="row px-2">
                                        <div class="form-group col-md-6"> <label class="form-control-label">Name on
                                                Card</label> <input type="text" id="cname" name="cname" required
                                                placeholder="Johnny Doe"> </div>
                                        <div class="form-group col-md-6"> <label class="form-control-label">Card
                                                Number</label> <input type="text" id="cnum" name="cnum"
                                                placeholder="1111 2222 3333 4444" required> </div>
                                    </div>
                                    <div class="row px-2">
                                        <div class="form-group col-md-6"> <label class="form-control-label">Expiration
                                                Date</label> <input type="text" id="exp" name="exp"
                                                placeholder="MM/YYYY" required>
                                        </div>
                                        <div class="form-group col-md-6"> <label class="form-control-label">CVV</label>
                                            <input type="password" id="cvv" name="cvv" placeholder="***" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <input class="form-control" type="hidden" id="token" value="token"
                                        name="token"></input>
                                </div>

                                <div class="col-lg-4 mt-2">
                                    <div class="row d-flex justify-content-between px-4">
                                        <p class="mb-1 text-left">Subtotal</p>
                                        <h6 id="subTotal" class="mb-1 text-right"></h6>
                                    </div>
                                    <div class="row d-flex justify-content-between px-4">
                                        <p class="mb-1 text-left">Shipping</p>
                                        <h6 class="mb-1 text-right">$2.99</h6>
                                    </div>
                                    <div class="row d-flex justify-content-between px-4" id="tax">
                                        <p class="mb-1 text-left">Total (tax included)</p>
                                        <h6 id="totalCost" class="mb-1 text-right"></h6>
                                    </div>
                                    <button id="testme" type="button" class="btn-block btn-blue">Checkout </button>
                                </div>

                                <script>
                                    function parseJwt(token) {
                                        var base64Url = token.split('.')[1];
                                        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                                        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                                        }).join(''));

                                        return JSON.parse(jsonPayload);
                                    };
                                    var decrypt = new JSEncrypt()
                                    publickey = "YOUR_PUBLIC_KEY";
                                    privatekey = "YOUR_RSA_PRIVATE_KEY";

                                    decrypt.setPrivateKey(privatekey)

                                    var user_data = "{{encryptedToken}}"

                                    decryptedToken = decrypt.decrypt(user_data)

                                    var splitData = decryptedToken.split('.')[1];

                                    var total = parseJwt(decryptedToken)
                                    var ship = 2.99

                                    var subTotal = total['totalCost'] - ship
                                    document.getElementById("subTotal").innerHTML = "$" + subTotal
                                    document.getElementById("totalCost").innerHTML = "$" + total['totalCost']


                                </script>


                            </div>


                        </div>
                    </div>
                </div>
            </form>

        </div>
        <script type='text/javascript'
            src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js'></script>
        <script type='text/javascript'>$(document).ready(function () {

                $('.radio-group .radio').click(function () {
                    $('.radio').addClass('gray');
                    $(this).removeClass('gray');
                });

                $('.plus-minus .plus').click(function () {
                    var count = $(this).parent().prev().text();
                    $(this).parent().prev().html(Number(count) + 1);
                });

                $('.plus-minus .minus').click(function () {
                    var count = $(this).parent().prev().text();
                    $(this).parent().prev().html(Number(count) - 1);
                });

            });</script>
    </body>

</html>